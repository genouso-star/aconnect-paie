<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AConnect Paie ‚Äì Formulaire de Facture</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --green: #1a6b4a;
    --green-light: #2a8a60;
    --green-dark: #0d4a33;
    --accent: #c8f5e0;
    --gold: #d4a853;
    --bg: #f4f7f5;
    --card: #ffffff;
    --text: #1a2320;
    --muted: #6b7d76;
    --border: #d1e0d9;
    --red: #c0392b;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  /* ===== HEADER ===== */
  .app-header {
    background: linear-gradient(135deg, var(--green-dark) 0%, var(--green) 100%);
    padding: 20px 40px;
    display: flex;
    align-items: center;
    gap: 16px;
    box-shadow: 0 4px 20px rgba(26,107,74,0.3);
  }
  .app-logo {
    width: 42px; height: 42px;
    background: white;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-family: 'DM Serif Display', serif;
    font-size: 20px;
    color: var(--green);
    font-weight: 900;
    letter-spacing: -1px;
  }
  .app-title { color: white; }
  .app-title h1 { font-family: 'DM Serif Display', serif; font-size: 22px; letter-spacing: 0.5px; }
  .app-title p { font-size: 12px; opacity: 0.7; margin-top: 2px; }

  .app-tabs {
    margin-left: auto;
    display: flex;
    gap: 4px;
    background: rgba(255,255,255,0.1);
    padding: 4px;
    border-radius: 12px;
  }
  .tab-btn {
    padding: 8px 20px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s;
    background: transparent;
    color: rgba(255,255,255,0.7);
  }
  .tab-btn.active {
    background: white;
    color: var(--green);
  }

  /* ===== LAYOUT ===== */
  .container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 40px 24px;
  }

  .page { display: none; }
  .page.active { display: block; }

  /* ===== FORM ===== */
  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
  }

  .form-section {
    background: var(--card);
    border-radius: 16px;
    padding: 28px;
    border: 1px solid var(--border);
    box-shadow: 0 2px 12px rgba(26,107,74,0.05);
  }
  .form-section.full { grid-column: 1 / -1; }

  .section-title {
    font-family: 'DM Serif Display', serif;
    font-size: 16px;
    color: var(--green);
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--accent);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .section-icon {
    width: 28px; height: 28px;
    background: var(--accent);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px;
  }

  .field-row { display: flex; gap: 14px; }
  .field { margin-bottom: 16px; flex: 1; }
  .field label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
  }
  .field input, .field select, .field textarea {
    width: 100%;
    padding: 10px 14px;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    color: var(--text);
    background: var(--bg);
    transition: all 0.2s;
    outline: none;
  }
  .field input:focus, .field select:focus, .field textarea:focus {
    border-color: var(--green);
    background: white;
    box-shadow: 0 0 0 3px rgba(26,107,74,0.1);
  }
  .field textarea { resize: vertical; min-height: 80px; }

  /* Payment method */
  .payment-box {
    background: var(--bg);
    border: 1.5px solid var(--border);
    border-radius: 12px;
    padding: 14px;
  }
  .payment-type-select {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    flex-wrap: wrap;
  }
  .pay-type-btn {
    padding: 6px 14px;
    border-radius: 20px;
    border: 1.5px solid var(--border);
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    background: white;
    color: var(--muted);
    transition: all 0.2s;
  }
  .pay-type-btn.active {
    background: var(--green);
    color: white;
    border-color: var(--green);
  }
  .payment-info-input {
    width: 100%;
    padding: 10px 14px;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    background: white;
    outline: none;
    transition: all 0.2s;
  }
  .payment-info-input:focus {
    border-color: var(--green);
    box-shadow: 0 0 0 3px rgba(26,107,74,0.1);
  }

  /* Lines table */
  .lines-table { width: 100%; border-collapse: collapse; }
  .lines-table th {
    background: var(--green);
    color: white;
    padding: 10px 12px;
    text-align: left;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .lines-table th:first-child { border-radius: 8px 0 0 8px; }
  .lines-table th:last-child { border-radius: 0 8px 8px 0; }
  .lines-table td {
    padding: 8px 6px;
    border-bottom: 1px solid var(--border);
  }
  .lines-table td input {
    width: 100%;
    padding: 8px 10px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    background: var(--bg);
    outline: none;
    transition: border-color 0.2s;
  }
  .lines-table td input:focus {
    border-color: var(--green);
    background: white;
  }
  .delete-line-btn {
    background: #fee;
    border: none;
    border-radius: 6px;
    padding: 6px 10px;
    cursor: pointer;
    color: var(--red);
    font-size: 14px;
    transition: all 0.2s;
  }
  .delete-line-btn:hover { background: #fcc; }

  .add-line-btn {
    margin-top: 12px;
    padding: 8px 18px;
    background: var(--accent);
    color: var(--green);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.2s;
  }
  .add-line-btn:hover { background: #b0ead0; }

  /* Totals */
  .totals-box {
    margin-top: 20px;
    background: var(--bg);
    border-radius: 12px;
    padding: 16px 20px;
    border: 1px solid var(--border);
  }
  .total-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    font-size: 14px;
  }
  .total-row.final {
    border-top: 2px solid var(--green);
    margin-top: 8px;
    padding-top: 12px;
    font-weight: 700;
    font-size: 16px;
    color: var(--green);
  }
  .total-row label { color: var(--muted); }

  /* Remise */
  .remise-input {
    padding: 5px 10px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-size: 13px;
    width: 80px;
    text-align: right;
    outline: none;
  }
  .remise-input:focus { border-color: var(--green); }

  /* CTA */
  .cta-bar {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 28px;
  }
  .btn-secondary {
    padding: 12px 24px;
    border: 2px solid var(--green);
    background: transparent;
    color: var(--green);
    border-radius: 12px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.2s;
  }
  .btn-secondary:hover { background: var(--accent); }

  .btn-primary {
    padding: 12px 28px;
    background: linear-gradient(135deg, var(--green), var(--green-light));
    color: white;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 700;
    font-family: 'DM Sans', sans-serif;
    box-shadow: 0 4px 14px rgba(26,107,74,0.3);
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(26,107,74,0.4);
  }

  /* ===== INVOICE PREVIEW ===== */
  #invoice-wrapper {
    background: white;
    max-width: 860px;
    margin: 0 auto;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 8px 40px rgba(0,0,0,0.12);
  }

  .invoice-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-bottom: 20px;
  }

  /* Invoice doc styles */
  #invoice-doc {
    padding: 40px 48px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    color: #1a2320;
  }

  .inv-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
  }
  .inv-employee-name {
    font-size: 17px;
    font-weight: 700;
    color: var(--green-dark);
  }
  .inv-date-block { text-align: right; }
  .inv-date-block .label { font-size: 11px; color: var(--muted); text-transform: uppercase; }
  .inv-date-block .value { font-size: 16px; font-weight: 700; }

  .inv-meta { margin-bottom: 6px; font-size: 12px; line-height: 1.7; }
  .inv-meta strong { color: var(--text); }

  .inv-num-block { margin-top: 4px; }
  .inv-num-label { font-size: 11px; color: var(--muted); text-transform: uppercase; }
  .inv-num-value { font-size: 14px; font-weight: 700; color: var(--green); }

  .inv-middle {
    display: flex;
    justify-content: flex-end;
    margin: 16px 0 24px;
  }
  .inv-sendto {
    border: 2px solid var(--green);
    border-radius: 4px;
    padding: 12px 20px;
    min-width: 260px;
    font-size: 12px;
    line-height: 1.8;
  }
  .inv-sendto .inv-sendto-title {
    font-weight: 700;
    color: var(--green);
    margin-bottom: 4px;
  }

  .inv-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 16px;
  }
  .inv-table thead tr {
    background: var(--green-dark);
    color: white;
  }
  .inv-table thead th {
    padding: 10px 12px;
    text-align: left;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
  }
  .inv-table thead th:not(:first-child) { text-align: center; }
  .inv-table tbody td {
    padding: 12px;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
  }
  .inv-table tbody td:not(:first-child) { text-align: center; }
  .inv-table tbody td:last-child { text-align: right; font-weight: 600; }

  .inv-totals {
    width: 300px;
    margin-left: auto;
    font-size: 12px;
  }
  .inv-total-row {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    border-bottom: 1px solid var(--border);
  }
  .inv-total-row.bold {
    font-weight: 700;
    font-size: 15px;
    border-top: 2px solid var(--green-dark);
    border-bottom: none;
    margin-top: 6px;
    padding-top: 8px;
    color: var(--green-dark);
  }

  .inv-note {
    margin-top: 24px;
    font-size: 11px;
    color: var(--muted);
  }
  .inv-payment {
    margin-top: 10px;
    font-size: 12px;
  }
  .inv-payment strong { color: var(--green-dark); }

  .inv-footer-box {
    margin-top: 24px;
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 14px;
    font-size: 11px;
    line-height: 1.8;
    background: #fafbfa;
    display: inline-block;
    min-width: 280px;
  }

  /* ===== PRINT ===== */
  @media print {
    body * { visibility: hidden; }
    #invoice-doc, #invoice-doc * { visibility: visible; }
    #invoice-doc {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      padding: 30px 40px;
      font-size: 11px;
    }
    .invoice-actions, .app-header, .app-tabs, .page#form-page { display: none !important; }
  }

  /* ===== TOAST ===== */
  .toast {
    position: fixed;
    bottom: 30px; right: 30px;
    background: var(--green-dark);
    color: white;
    padding: 14px 22px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 500;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    transform: translateY(80px);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    z-index: 999;
  }
  .toast.show { transform: translateY(0); opacity: 1; }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }
  .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
  .empty-state h3 { font-family: 'DM Serif Display', serif; font-size: 20px; color: var(--text); margin-bottom: 8px; }
  .empty-state p { font-size: 14px; }
</style>
</head>
<body>

<div class="app-header">
  <div class="app-logo">AC</div>
  <div class="app-title">
    <h1>AConnect Paie</h1>
    <p>Portail de gestion des factures</p>
  </div>
  <div class="app-tabs">
    <button class="tab-btn active" onclick="showPage('form')">üìù Nouvelle facture</button>
    <button class="tab-btn" onclick="showPage('preview')" id="preview-tab">üëÅ Aper√ßu PDF</button>
  </div>
</div>

<!-- FORM PAGE -->
<div class="page active" id="form-page">
<div class="container">
  <div class="form-grid">

    <!-- Infos facture -->
    <div class="form-section">
      <div class="section-title"><span class="section-icon">üßæ</span> Informations de la facture</div>
      <div class="field">
        <label>Num√©ro de facture</label>
        <input type="text" id="f_num" placeholder="ACONNECT-008-2025-01-23" />
      </div>
      <div class="field">
        <label>Date</label>
        <input type="date" id="f_date" />
      </div>
      <div class="field">
        <label>LOT / Adresse chantier</label>
        <input type="text" id="f_lot" placeholder="LOT 020 BIS/I MMA IV MAMORY" />
      </div>
    </div>

    <!-- Infos employ√© -->
    <div class="form-section">
      <div class="section-title"><span class="section-icon">üë§</span> Informations de l'employ√©</div>
      <div class="field">
        <label>Nom complet</label>
        <input type="text" id="f_name" placeholder="Ex: RAJAONERA Heriandoniaina Francki" />
      </div>
      <div class="field-row">
        <div class="field">
          <label>Num√©ro d'immatriculation</label>
          <input type="text" id="f_immat" placeholder="Ex: 123456" />
        </div>
      </div>
      <div class="field-row">
        <div class="field">
          <label>NIF</label>
          <input type="text" id="f_nif" placeholder="Ex: 4013779407" />
        </div>
        <div class="field">
          <label>STAT</label>
          <input type="text" id="f_stat" placeholder="Ex: 70202112025008022" />
        </div>
      </div>
    </div>

    <!-- Infos contact -->
    <div class="form-section">
      <div class="section-title"><span class="section-icon">üìû</span> Contact & Localisation</div>
      <div class="field">
        <label>Num√©ro de t√©l√©phone</label>
        <input type="text" id="f_phone" placeholder="+261 34 27 18 772" />
      </div>
      <div class="field">
        <label>Nom Mvola</label>
        <input type="text" id="f_mvola_name" placeholder="Ex: heriandoniainaFranck" />
      </div>
      <div class="field-row">
        <div class="field">
          <label>Province</label>
          <input type="text" id="f_province" placeholder="Antananarivo" />
        </div>
        <div class="field">
          <label>R√©gion</label>
          <input type="text" id="f_region" placeholder="Analamanga" />
        </div>
      </div>
      <div class="field">
        <label>Ville</label>
        <input type="text" id="f_ville" placeholder="Antananarivo" />
      </div>
    </div>

    <!-- Moyen de paiement -->
    <div class="form-section">
      <div class="section-title"><span class="section-icon">üí≥</span> Moyen de paiement</div>
      <div class="payment-box">
        <div class="payment-type-select" id="pay-types">
          <button class="pay-type-btn active" onclick="selectPayType(this, 'Mvola')">üì± Mvola</button>
          <button class="pay-type-btn" onclick="selectPayType(this, 'Orange Money')">üî∂ Orange Money</button>
          <button class="pay-type-btn" onclick="selectPayType(this, 'Virement bancaire')">üè¶ Virement</button>
          <button class="pay-type-btn" onclick="selectPayType(this, 'Esp√®ces')">üíµ Esp√®ces</button>
        </div>
        <input class="payment-info-input" type="text" id="f_pay_info" 
               placeholder="Ex: heriandoniainaFranck (+261342718772)" />
      </div>
      <div class="field" style="margin-top:14px;">
        <label>Remarques / Notes</label>
        <textarea id="f_notes" placeholder="Remarques, notes et instructions de paiement..."></textarea>
      </div>
    </div>

    <!-- Lignes de prestation -->
    <div class="form-section full">
      <div class="section-title"><span class="section-icon">‚è±</span> Description des prestations</div>
      <table class="lines-table">
        <thead>
          <tr>
            <th style="width:38%">Description</th>
            <th style="width:15%">Quantit√© (h)</th>
            <th style="width:15%">Taux horaire ($CAD)</th>
            <th style="width:15%">Taux facturation (%)</th>
            <th style="width:12%">Total</th>
            <th style="width:5%"></th>
          </tr>
        </thead>
        <tbody id="lines-body"></tbody>
      </table>
      <button class="add-line-btn" onclick="addLine()">+ Ajouter une ligne</button>

      <div class="totals-box">
        <div class="total-row">
          <label>Sous-total</label>
          <span id="subtotal">0.00 $</span>
        </div>
        <div class="total-row">
          <label>Remise (%)</label>
          <input class="remise-input" type="number" id="f_remise" value="0" min="0" max="100" oninput="recalc()" />
        </div>
        <div class="total-row">
          <label>Sous-total moins remises</label>
          <span id="after_remise">0.00 $</span>
        </div>
        <div class="total-row final">
          <label>SOLDE DU ($CAD)</label>
          <span id="total_final">0.00 $</span>
        </div>
      </div>
    </div>

  </div>

  <div class="cta-bar">
    <button class="btn-secondary" onclick="resetForm()">üîÑ R√©initialiser</button>
    <button class="btn-primary" onclick="generateInvoice()">
      üìÑ G√©n√©rer la facture
    </button>
  </div>
</div>
</div>

<!-- PREVIEW PAGE -->
<div class="page" id="preview-page">
<div class="container">
  <div id="empty-preview" class="empty-state">
    <div class="icon">üìã</div>
    <h3>Aucune facture g√©n√©r√©e</h3>
    <p>Remplissez le formulaire puis cliquez sur "G√©n√©rer la facture".</p>
  </div>

  <div id="invoice-wrapper" style="display:none;">
    <div class="invoice-actions">
      <button class="btn-secondary" onclick="showPage('form')">‚úèÔ∏è Modifier</button>
      <button class="btn-primary" onclick="window.print()">üñ®Ô∏è Imprimer / Enregistrer PDF</button>
    </div>
    <div id="invoice-doc"></div>
  </div>
</div>
</div>

<div class="toast" id="toast">‚úÖ Facture g√©n√©r√©e avec succ√®s !</div>

<script>
// ===== STATE =====
let lines = [];
let payType = 'Mvola';

// ===== INIT =====
document.addEventListener('DOMContentLoaded', () => {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('f_date').value = today;
  addLine();
  autoFillNum();
});

function autoFillNum() {
  const d = new Date();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  document.getElementById('f_num').value = `ACONNECT-001-${d.getFullYear()}-${mm}-${dd}`;
}

// ===== TABS =====
function showPage(p) {
  document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
  document.getElementById(p + '-page').classList.add('active');
  document.querySelectorAll('.tab-btn')[p === 'form' ? 0 : 1].classList.add('active');
}

// ===== PAYMENT =====
function selectPayType(btn, type) {
  document.querySelectorAll('.pay-type-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  payType = type;
  document.getElementById('f_pay_info').placeholder = type === 'Mvola' ? 'Ex: heriandoniainaFranck (+261342718772)' :
    type === 'Orange Money' ? 'Ex: num√©ro Orange Money' :
    type === 'Virement bancaire' ? 'Ex: IBAN / BIC / Banque' : 'Paiement en esp√®ces';
}

// ===== LINES =====
let lineId = 0;
function addLine() {
  const id = ++lineId;
  lines.push({ id, desc: '', qty: 0, rate: 0, taux: 100 });
  renderLines();
}

function renderLines() {
  const tbody = document.getElementById('lines-body');
  tbody.innerHTML = '';
  lines.forEach((l, i) => {
    const total = calcLineTotal(l);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" placeholder="Service de prestation du JJ/MM/AAAA ‚Äì JJ/MM/AAAA" value="${l.desc}" oninput="lines[${i}].desc=this.value" /></td>
      <td><input type="number" placeholder="0" value="${l.qty || ''}" oninput="lines[${i}].qty=parseFloat(this.value)||0;recalc()" /></td>
      <td><input type="number" placeholder="0.00" value="${l.rate || ''}" oninput="lines[${i}].rate=parseFloat(this.value)||0;recalc()" /></td>
      <td><input type="number" placeholder="100" value="${l.taux}" oninput="lines[${i}].taux=parseFloat(this.value)||100;recalc()" /></td>
      <td style="text-align:right;font-weight:600;padding-right:8px">${total.toFixed(2)} $</td>
      <td><button class="delete-line-btn" onclick="deleteLine(${i})">‚úï</button></td>
    `;
    tbody.appendChild(tr);
  });
  recalc();
}

function deleteLine(i) {
  lines.splice(i, 1);
  renderLines();
}

function calcLineTotal(l) {
  return (l.qty * l.rate * (l.taux / 100));
}

function recalc() {
  const sub = lines.reduce((s, l) => s + calcLineTotal(l), 0);
  const remise = parseFloat(document.getElementById('f_remise').value) || 0;
  const after = sub * (1 - remise / 100);
  document.getElementById('subtotal').textContent = sub.toFixed(2) + ' $';
  document.getElementById('after_remise').textContent = after.toFixed(2) + ' $';
  document.getElementById('total_final').textContent = after.toFixed(2) + ' $';
  // update last column in table
  const cells = document.querySelectorAll('#lines-body tr td:nth-child(5)');
  cells.forEach((td, i) => {
    if (lines[i]) td.textContent = calcLineTotal(lines[i]).toFixed(2) + ' $';
  });
}

// ===== RESET =====
function resetForm() {
  if (!confirm('R√©initialiser le formulaire ?')) return;
  ['f_name','f_lot','f_immat','f_nif','f_stat','f_phone','f_mvola_name',
   'f_province','f_region','f_ville','f_pay_info','f_notes'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  document.getElementById('f_remise').value = 0;
  lines = []; lineId = 0;
  addLine();
  autoFillNum();
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('f_date').value = today;
}

// ===== GENERATE INVOICE =====
function generateInvoice() {
  const v = id => (document.getElementById(id) || {}).value || '';
  const name = v('f_name');
  if (!name) { alert('Veuillez renseigner le nom complet.'); return; }

  const dateRaw = v('f_date');
  const dateFormatted = dateRaw ? new Date(dateRaw + 'T12:00:00').toLocaleDateString('fr-FR') : '';

  const sub = lines.reduce((s, l) => s + calcLineTotal(l), 0);
  const remise = parseFloat(v('f_remise')) || 0;
  const afterRemise = sub * (1 - remise / 100);

  const linesHTML = lines.filter(l => l.desc || l.qty || l.rate).map(l => `
    <tr>
      <td>${l.desc || '‚Äì'}</td>
      <td>${l.qty.toFixed(2)}</td>
      <td>${l.rate.toFixed(2)} $</td>
      <td>${l.taux.toFixed(2)}%</td>
      <td>${calcLineTotal(l).toFixed(2)} $</td>
    </tr>
  `).join('');

  const immat = v('f_immat');
  const nif = v('f_nif');
  const stat = v('f_stat');
  const lot = v('f_lot');
  const payInfo = v('f_pay_info');
  const notes = v('f_notes');
  const province = v('f_province');
  const region = v('f_region');
  const ville = v('f_ville');
  const phone = v('f_phone');
  const mvolaName = v('f_mvola_name');

  const html = `
    <div class="inv-top">
      <div>
        <div class="inv-employee-name">${name}</div>
        <div class="inv-meta" style="margin-top:10px;">
          ${lot ? `<div>${lot}</div>` : ''}
          ${immat ? `<div><strong>Num√©ro d'immatriculation :</strong> ${immat}</div>` : ''}
          ${nif ? `<div><strong>NIF :</strong> ${nif}</div>` : ''}
          ${stat ? `<div><strong>STAT :</strong> ${stat}</div>` : ''}
        </div>
      </div>
      <div class="inv-date-block">
        <div class="label">Date</div>
        <div class="value">${dateFormatted}</div>
        <div style="margin-top:10px;">
          <div class="inv-num-label">N¬∞ de facture</div>
          <div class="inv-num-value">${v('f_num')}</div>
        </div>
      </div>
    </div>

    <div class="inv-middle">
      <div class="inv-sendto">
        <div class="inv-sendto-title">Envover √†</div>
        <div>Les Services Aconnect Inc.</div>
        <div>6248 rue Kaiser</div>
        <div>Rawdon, QC J0K 1S0</div>
        <div>+1(450)-400-2101</div>
        <div>info@aconnect.ca</div>
      </div>
    </div>

    <table class="inv-table">
      <thead>
        <tr>
          <th>Description</th>
          <th>Quantit√© (heure)</th>
          <th>Taux horaire ($CAD)</th>
          <th>Taux de facturation</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        ${linesHTML || '<tr><td colspan="5" style="text-align:center;color:#999">‚Äì</td></tr>'}
      </tbody>
    </table>

    <div class="inv-totals">
      <div class="inv-total-row"><span>Sous-total</span><span>${sub.toFixed(2)} $</span></div>
      <div class="inv-total-row"><span>Sous-total moins les remises</span><span>${afterRemise.toFixed(2)} $ ${remise > 0 ? '(*)' : ''}</span></div>
      <div class="inv-total-row bold"><span>Solde du ($CAD)</span><span>${afterRemise.toFixed(2)} $</span></div>
    </div>

    ${remise > 0 ? `<p style="font-size:11px;color:#888;margin-top:8px;text-align:right;">(*): nous ne sommes pas assujettis √† la TVA</p>` : `<p style="font-size:11px;color:#888;margin-top:8px;text-align:right;">(*): nous ne sommes pas assujettis √† la TVA</p>`}

    <div class="inv-note">
      ${notes ? `<p>Remarques, notes et instructions de paiement:</p>` : '<p>Remarques, notes et instructions de paiement:</p>'}
    </div>
    <div class="inv-payment">
      <strong>Modalit√©s de r√®glement :</strong> ${payType}${payInfo ? ' ‚Äî ' + payInfo : ''}
    </div>

    <div class="inv-footer-box">
      <div><strong>Nom:</strong>${name.split(' ')[0] || ''}</div>
      <div><strong>Pr√©nom:</strong> ${name.split(' ').slice(1).join(' ') || ''}</div>
      ${phone ? `<div><strong>Numero :</strong> ${phone}</div>` : ''}
      ${mvolaName ? `<div><strong>Nom Mvola :</strong> ${mvolaName}</div>` : ''}
      ${province ? `<div><strong>Province :</strong> ${province}</div>` : ''}
      ${region ? `<div><strong>Region :</strong> ${region}</div>` : ''}
      ${ville ? `<div><strong>Ville :</strong> ${ville}</div>` : ''}
    </div>
  `;

  document.getElementById('invoice-doc').innerHTML = html;
  document.getElementById('invoice-wrapper').style.display = 'block';
  document.getElementById('empty-preview').style.display = 'none';

  showPage('preview');
  showToast('‚úÖ Facture g√©n√©r√©e avec succ√®s !');
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}
</script>
</body>
</html>
